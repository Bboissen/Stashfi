name: API Gateway CI

concurrency:
  group: api-gateway-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main, "feat/**", "fix/**" ]
    paths:
      - 'services/api-gateway/**'
      - '.github/workflows/api-gateway-ci.yml'
      - '.github/workflows/_reusable-*.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'services/api-gateway/**'
      - '.github/workflows/api-gateway-ci.yml'
      - '.github/workflows/_reusable-*.yml'

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  dedupe:
    name: Skip duplicate runs
    runs-on: ubuntu-24.04
    outputs:
      should_skip: ${{ steps.skip.outputs.should_skip }}
    steps:
      - id: skip
        uses: fkirc/skip-duplicate-actions@v5.3.1
        with:
          concurrent_skipping: 'same_content_newer'
          cancel_others: 'true'
          skip_after_successful_duplicate: 'true'
          do_not_skip: '["pull_request"]'
  # Go testing and linting
  test:
    name: Test & Lint
    needs: [dedupe]
    if: needs.dedupe.outputs.should_skip != 'true'
    uses: ./.github/workflows/_reusable-go-test.yml
    with:
      service_path: ./services/api-gateway
      go_version: '1.25.1'
      coverage_threshold: 50

  # Security scanning
  security:
    name: Security Scan
    needs: [dedupe]
    if: needs.dedupe.outputs.should_skip != 'true'
    uses: ./.github/workflows/_reusable-security-scan.yml
    with:
      language: go
      scan_path: ./services/api-gateway

  # Docker build
  docker:
    name: Build Docker Image
    needs: [test, dedupe]
    if: needs.dedupe.outputs.should_skip != 'true'
    uses: ./.github/workflows/_reusable-docker-build.yml
    with:
      image_name: api-gateway
      dockerfile_path: ./services/api-gateway
      push: ${{ github.ref == 'refs/heads/main' }}
