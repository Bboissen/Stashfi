name: API Gateway CI

concurrency:
  group: api-gateway-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
    paths:
      - 'services/api-gateway/**'
      - '.github/workflows/api-gateway-ci.yml'
      - '.github/workflows/_reusable-*.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'services/api-gateway/**'
      - '.github/workflows/api-gateway-ci.yml'
      - '.github/workflows/_reusable-*.yml'

permissions:
  contents: read
  packages: write
  actions: write
  security-events: write

jobs:
  # Go testing and linting
  test:
    name: Test & Lint
    uses: ./.github/workflows/_reusable-go-test.yml
    with:
      service_path: ./services/api-gateway
      go_version: '1.25.1'
      coverage_threshold: 50

  # Security scanning
  security:
    name: Security Scan
    uses: ./.github/workflows/_reusable-security-scan.yml
    with:
      language: go
      scan_path: ./services/api-gateway

  # Docker build
  docker:
    name: Build Docker Image
    needs: [test]
    uses: ./.github/workflows/_reusable-docker-build.yml
    with:
      image_name: api-gateway
      dockerfile_path: ./services/api-gateway
      push: ${{ github.ref == 'refs/heads/main' }}
